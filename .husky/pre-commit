#!/bin/sh
echo "üß™ Running tests before commit..."

# Get the root directory of the git repo
ROOT_DIR=$(git rev-parse --show-toplevel)
cd "$ROOT_DIR" || exit 1

# Run worker tests
echo "üì¶ Testing worker..."
cd worker || exit 1
WORKER_TEST_OUTPUT=$(npm test -- --passWithNoTests 2>&1)
WORKER_EXIT_CODE=$?
echo "$WORKER_TEST_OUTPUT" | tail -3
if [ $WORKER_EXIT_CODE -ne 0 ]; then
  echo ""
  echo "‚ùå Worker tests failed!"
  echo "$WORKER_TEST_OUTPUT" | grep -E "FAIL|‚óè|Error|at " | head -30
  exit 1
fi
cd "$ROOT_DIR" || exit 1

# Run conductor tests (excluding websocket test that times out)
echo "üéº Testing conductor..."
cd conductor || exit 1
CONDUCTOR_TEST_OUTPUT=$(npm test -- --testPathPattern="api.test|auth.test|token.test|database.test" --testPathIgnorePatterns="websocket.test" --passWithNoTests 2>&1)
CONDUCTOR_EXIT_CODE=$?
echo "$CONDUCTOR_TEST_OUTPUT" | tail -3
if [ $CONDUCTOR_EXIT_CODE -ne 0 ]; then
  echo ""
  echo "‚ùå Conductor tests failed!"
  echo "$CONDUCTOR_TEST_OUTPUT" | grep -E "FAIL|‚óè|Error|at " | head -30
  echo ""
  echo "üí° Tip: If containers are running, they might be interfering."
  echo "   Try: cd conductor && docker compose down"
  exit 1
fi
cd "$ROOT_DIR" || exit 1

echo "‚úÖ All tests passed! Proceeding with commit..."
